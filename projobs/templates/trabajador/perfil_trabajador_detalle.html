{% extends 'baseperfil.html' %}
{% load static %}

{% block content %}
<!-- Contenedor principal del perfil del trabajador -->
<div class="perfil-trabajador-box">
  <h2>Perfil del Trabajador</h2>

  <!-- Informaci√≥n general del trabajador -->
  <div class="perfil-trabajador-info">
    {% if trabajador.foto %}
      <!-- Si tiene foto, se muestra -->
      <img src="{{ trabajador.foto.url }}" alt="Foto" class="foto-trabajador">
    {% else %}
      <!-- Foto por defecto si no tiene -->
      <img src="{% static 'img/perfil_default.png' %}" alt="Foto por defecto" class="foto-trabajador">
    {% endif %}
    <div>
      <h3>{{ trabajador.nombre }} {{ trabajador.apellido }}</h3>
      <!-- Bot√≥n para iniciar chat -->
      <a href="{% url 'chat_con_usuario' trabajador.id %}" class="btn-mensaje">üí¨ Enviar mensaje</a>
      <!-- Calificaci√≥n promedio visual en estrellas -->
      <p><strong>Calificaci√≥n promedio:</strong> 
        <span class="estrellas-promedio">
          {% for i in "12345" %}
            {% if forloop.counter <= promedio %}
              <span class="estrella llena">‚òÖ</span>
            {% else %}
              <span class="estrella vacia">‚òÜ</span>
            {% endif %}
          {% endfor %}
        </span>
        ({{ promedio }}/5)
      </p>
      <!-- Enlace para regresar al historial -->
      <a href="{% url 'historial_postulaciones' %}" class="btn-volver">‚Üê Volver al historial</a>
    </div>
  </div>

  <hr>

  <!-- Formulario para calificar al trabajador -->
  <form method="post" class="form-calificacion">
    {% csrf_token %}
    <label>Tu Calificaci√≥n:</label>
    <div class="estrellas">
      {% for i in "54321" %}
        <!-- Radios para seleccionar calificaci√≥n -->
        <input type="radio" id="estrella{{ i }}" name="calificacion" value="{{ i }}">
        <label for="estrella{{ i }}">‚òÖ</label>
      {% endfor %}
    </div>

    <!-- Campo para comentario -->
    <label for="comentario">Comentario:</label>
    <textarea name="comentario" id="comentario" rows="4" required></textarea>

    <!-- Bot√≥n de env√≠o -->
    <button type="submit">Guardar Calificaci√≥n</button>
  </form>

  <hr>

  <!-- Comentarios anteriores -->
  <h3>Comentarios de otros clientes:</h3>
  {% if calificaciones %}
    <div id="comentarios">
      {% for c in calificaciones %}
        <div class="comentario-box {% if forloop.counter > 3 %}oculto{% endif %}">
          <p><strong>Puntuaci√≥n:</strong> 
            <span class="estrellas-promedio">
              {% for i in "12345" %}
                {% if forloop.counter <= c.puntuacion %}
                  <span class="estrella llena">‚òÖ</span>
                {% else %}
                  <span class="estrella vacia">‚òÜ</span>
                {% endif %}
              {% endfor %}
            </span>
            ({{ c.puntuacion }}/5)
          </p>
          <!-- Comentario escrito -->
          <p><strong>Comentario:</strong> {{ c.comentario }}</p>
          <p><small><strong>Fecha:</strong> {{ c.fecha|date:"Y-m-d H:i" }}</small></p>
          <hr>
        </div>
      {% endfor %}
    </div>
    <!-- Bot√≥n para expandir/contraer comentarios -->
    {% if calificaciones|length > 3 %}
      <button id="verMasBtn" onclick="toggleComentarios()">‚ñº Ver m√°s</button>
    {% endif %}
  {% else %}
    <p>No hay comentarios a√∫n.</p>
  {% endif %}

  <hr>

  <!-- Evidencias subidas por el trabajador -->
  <h3>Evidencias del trabajador:</h3>
  {% if trabajador.evidencia_set.all %}
    <div class="grid-evidencias">
      {% for ev in trabajador.evidencia_set.all %}
        <!-- Cada evidencia se muestra como miniatura -->
        <div class="evidencia-item" onclick="mostrarEvidencia('{{ ev.archivo.url }}', `{{ ev.descripcion|default:"Sin descripci√≥n" }}`, '{{ ev.fecha|date:"Y-m-d H:i" }}')">
          <img src="{{ ev.archivo.url }}" alt="Evidencia" class="miniatura-evidencia">
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p>Este trabajador a√∫n no ha subido evidencias.</p>
  {% endif %}

  <!-- Modal que se abre al hacer clic en una evidencia -->
  <div id="modalVistaEvidencia" class="modal hidden">
    <div class="modal-contenido">
      <button onclick="cerrarModalEvidencia()" class="modal-cerrar">&times;</button>
      <img id="imagenAmpliada" src="" alt="Vista ampliada" class="imagen-ampliada" />
      <p id="comentarioEvidencia" class="comentario-evidencia"></p>
      <p id="fechaEvidencia" class="fecha-evidencia"></p>
    </div>
  </div>
</div>

<!-- Estilos adicionales espec√≠ficos -->
<style>
  /* Grid de miniaturas de evidencia */
  .grid-evidencias {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 1rem;
  }

  .evidencia-item {
    width: 120px;
    height: 120px;
    cursor: pointer;
    overflow: hidden;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  }

  .miniatura-evidencia {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.2s ease-in-out;
  }

  .miniatura-evidencia:hover {
    transform: scale(1.05);
  }

  .hidden {
    display: none !important;
  }

  #modalVistaEvidencia {
    position: fixed;
    top: 0; left: 0;
    right: 0; bottom: 0;
    background-color: rgba(0,0,0,0.8);
    z-index: 999;
    justify-content: center;
    align-items: center;
  }

  #modalVistaEvidencia.modal-contenido {
    display: flex;
  }

  #modalVistaEvidencia .modal-contenido {
    background-color: #fff;
    padding: 2rem;
    border-radius: 12px;
    max-width: 600px;
    width: 100%;
    text-align: center;
  }

  .imagen-ampliada {
    width: 100%;
    max-height: 400px;
    object-fit: contain;
    margin-bottom: 1rem;
  }

  .comentario-evidencia {
    font-style: italic;
    color: #444;
    margin-bottom: 0.5rem;
  }

  .fecha-evidencia {
    font-size: 0.9rem;
    color: #777;
  }
</style>

<!-- Script para interacci√≥n con evidencias y comentarios -->
<script>
  function toggleComentarios() {
    const ocultos = document.querySelectorAll('.comentario-box.oculto');
    const btn = document.getElementById('verMasBtn');
    const visibles = Array.from(ocultos).filter(e => e.style.display !== 'block');

    if (visibles.length > 0) {
      ocultos.forEach(e => e.style.display = 'block');
      btn.textContent = "‚ñ≤ Ver menos";
    } else {
      ocultos.forEach((e, i) => e.style.display = i < 3 ? 'block' : 'none');
      btn.textContent = "‚ñº Ver m√°s";
    }
  }

  window.onload = () => {
    const ocultos = document.querySelectorAll('.comentario-box.oculto');
    ocultos.forEach((e, i) => {
      e.style.display = i < 3 ? 'block' : 'none';
    });
  };

  function mostrarEvidencia(url, comentario, fecha) {
    const modal = document.getElementById('modalVistaEvidencia');
    modal.classList.remove('hidden');
    modal.style.display = 'flex';
    document.getElementById('imagenAmpliada').src = url;
    document.getElementById('comentarioEvidencia').innerText = comentario;
    document.getElementById('fechaEvidencia').innerText = 'üìÖ ' + fecha;
  }

  function cerrarModalEvidencia() {
    const modal = document.getElementById('modalVistaEvidencia');
    modal.classList.add('hidden');
    modal.style.display = 'none';
    document.getElementById('imagenAmpliada').src = '';
  }

  // Previene acciones de inspecci√≥n de c√≥digo
  document.addEventListener('contextmenu', e => e.preventDefault());
  document.addEventListener('keydown', e => {
    if (e.key === "F12" || (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J")) || (e.ctrlKey && e.key === "U")) {
      e.preventDefault();
    }
  });
</script>
{% endblock %}
