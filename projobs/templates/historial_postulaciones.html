{% extends 'baseperfil.html' %}  {# Extiende la plantilla base del perfil del usuario #}
{% load static %}  {# Carga el tag static para utilizar archivos est√°ticos como CSS o im√°genes #}

{# Bloque para cargar CSS adicional espec√≠fico de esta vista #}
{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/style_historial_postulaciones.css' %}">
{% endblock %}

{# Bloque principal de contenido #}
{% block content %}
<div class="ofertas-container historial-postulaciones">
  <h2 class="oferta-titulo-principal">Historial de Postulaciones</h2>

  {# Itera sobre todas las postulaciones que llegan desde la vista #}
  {% for p in postulaciones %}
    <div class="oferta-card">
      <div class="oferta-header">
        <div class="oferta-titulo">{{ p.oferta.titulo }}</div>
        <div class="oferta-ubicacion">
          <i class="fas fa-calendar"></i> {{ p.fecha_postulacion|date:"Y-m-d H:i" }}
        </div>
      </div>

      <div class="oferta-desc">
        {# SI el usuario autenticado es un CLIENTE (rol 2) #}
        {% if usuario.rol == 2 %}
          <p><strong>Trabajador:</strong>
            <a href="{% url 'perfil_trabajador_detalle' p.trabajador.id %}" class="enlace-perfil">
              {{ p.trabajador.nombre }} {{ p.trabajador.apellido }}
            </a>
          </p>

          {# Bot√≥n para iniciar chat con el trabajador #}
          <a href="{% url 'chat_con_usuario' p.trabajador.id %}" class="postular-btn">Chatear</a>

          {# Formulario para actualizar el estado de la postulaci√≥n #}
          <form method="post" class="historial-form">
            {% csrf_token %}
            <input type="hidden" name="postulacion_id" value="{{ p.id }}">

            {# Si ya est√° finalizada y fue aceptada, se bloquean los controles #}
            {% if p.finalizada and p.estado == 'aceptado' %}
              <p><span class="estado estado-finalizado">‚úÖ Finalizado</span></p>
              <select name="estado" disabled>
                <option selected>{{ p.estado|capfirst }}</option>
              </select>
              <button type="submit" class="postular-btn" disabled>Actualizar</button>
            {% else %}
              {# Selecci√≥n de estado editable si a√∫n no est√° finalizada #}
              <select name="estado">
                <option value="pendiente" {% if p.estado == "pendiente" %}selected{% endif %}>Pendiente</option>
                <option value="aceptado" {% if p.estado == "aceptado" %}selected{% endif %}>Aceptado</option>
                <option value="rechazado" {% if p.estado == "rechazado" %}selected{% endif %}>Rechazado</option>
              </select>
              <button type="submit" class="postular-btn-ac">Actualizar</button>
            {% endif %}
          </form>

        {# SI el usuario es un TRABAJADOR (rol 3) #}
        {% elif usuario.rol == 3 %}
          <p><strong>Cliente:</strong> {{ p.oferta.cliente.nombre }} {{ p.oferta.cliente.apellido }}</p>

          {# Bot√≥n para iniciar chat con el cliente #}
          <a href="{% url 'chat_con_usuario' p.oferta.cliente.id %}" class="postular-btn">Chatear</a>

          {# Mostrar estado de la postulaci√≥n #}
          <p><strong>Estado:</strong>
            {% if p.finalizada %}
              <span class="estado estado-finalizado">Finalizado</span>
            {% else %}
              <span class="estado estado-{{ p.estado }}">{{ p.estado|capfirst }}</span>
            {% endif %}
          </p>

          {# Bot√≥n para eliminar la postulaci√≥n (solo si no est√° finalizada) #}
          <form method="post" class="historial-form" onsubmit="return confirm('¬øSeguro que deseas eliminar esta postulaci√≥n?');">
            {% csrf_token %}
            <input type="hidden" name="postulacion_id" value="{{ p.id }}">
            <button type="submit" class="postular-btn-borrar" {% if p.finalizada %}disabled{% endif %}>üóëÔ∏è Eliminar</button>
          </form>
        {% endif %}
      </div>
    </div>

  {# Si no hay postulaciones en la lista #}
  {% empty %}
    <p>No hay postulaciones.</p>
  {% endfor %}
</div>
{% endblock %}
